// JobVerse Prisma Schema
// 数据库模型定义

generator client {
  provider = "prisma-client-js"
  // 明确指定二进制目标，优先使用 OpenSSL 3.0.x（Alpine Linux 默认）
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl", "linux-musl-arm64-openssl-3.0.x"]
}

// 配置 seed 脚本
// 运行方式: pnpm db:seed 或 npx ts-node prisma/seed.ts

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户相关模型
// ============================================

/// 用户表
model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         UserRole  @default(STUDENT)
  name         String?
  phone        String?
  avatar       String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 关联关系
  applications Application[]
  bookmarks    Bookmark[]
  employerInfo EmployerInfo?
  reviews      Review[]

  @@map("users")
}

/// 用户角色枚举
enum UserRole {
  STUDENT        // 学生求职者
  EMPLOYER       // 企业招聘负责人
  SCHOOL_ADMIN   // 高校就业中心管理员
  PLATFORM_ADMIN // 平台管理员
}

// ============================================
// 企业相关模型
// ============================================

/// 企业表
model Company {
  id               String   @id @default(uuid())
  name             String
  industry         String?
  scale            String?
  location         String?
  description      String?  @db.Text
  logo             String?
  website          String?
  contactPerson    String?  @map("contact_person")
  contactPhone     String?  @map("contact_phone")
  contactEmail     String?  @map("contact_email")
  verifiedBySchool Boolean  @default(false) @map("verified_by_school")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // 关联关系
  jobs         Job[]
  employerInfo EmployerInfo[]

  @@map("companies")
}

/// 企业用户关联表
model EmployerInfo {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  companyId String   @map("company_id")
  position  String?  // 在企业中的职位
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("employer_info")
}

// ============================================
// 岗位相关模型
// ============================================

/// 岗位表
model Job {
  id           String    @id @default(uuid())
  companyId    String    @map("company_id")
  title        String
  location     String
  salaryMin    Int?      @map("salary_min")
  salaryMax    Int?      @map("salary_max")
  description  String?   @db.Text
  requirements String?   @db.Text
  tags         String[]
  status       JobStatus @default(DRAFT)
  expiresAt    DateTime? @map("expires_at")  // 岗位有效期（BR-02 要求）
  isHighRisk   Boolean   @default(false) @map("is_high_risk")  // 高风险标记
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 关联关系
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applications Application[]
  bookmarks    Bookmark[]
  reviews      Review[]

  @@index([title])
  @@index([location])
  @@index([status])
  @@map("jobs")
}

/// 岗位状态枚举
enum JobStatus {
  DRAFT          // 草稿
  PENDING_REVIEW // 待审核
  APPROVED       // 已审核通过
  REJECTED       // 已驳回
  OFFLINE        // 已下线
}

// ============================================
// 投递相关模型
// ============================================

/// 投递记录表
model Application {
  id          String            @id @default(uuid())
  userId      String            @map("user_id")
  jobId       String            @map("job_id")
  status      ApplicationStatus @default(APPLIED)
  resume      String?           @db.Text
  coverLetter String?           @db.Text @map("cover_letter")
  appliedAt   DateTime          @default(now()) @map("applied_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@map("applications")
}

/// 投递状态枚举
enum ApplicationStatus {
  APPLIED      // 已投递
  VIEWED       // 已查看
  INTERVIEWING // 面试中
  ACCEPTED     // 已录用
  REJECTED     // 不合适
}

/// 收藏表
model Bookmark {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  jobId     String   @map("job_id")
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@map("bookmarks")
}

// ============================================
// 审核相关模型
// ============================================

/// 审核记录表
model Review {
  id         String       @id @default(uuid())
  jobId      String       @map("job_id")
  reviewerId String       @map("reviewer_id")
  status     ReviewStatus @default(PENDING)
  comment    String?      @db.Text
  reviewedAt DateTime?    @map("reviewed_at")
  createdAt  DateTime     @default(now()) @map("created_at")

  // 关联关系
  job      Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  reviewer User @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([reviewerId])
  @@map("reviews")
}

/// 审核状态枚举
enum ReviewStatus {
  PENDING  // 待审核
  APPROVED // 通过
  REJECTED // 驳回
  RETURNED // 退回修改
}

// ============================================
// 风控相关模型
// ============================================

/// 风控规则表
model RiskRule {
  id        String   @id @default(uuid())
  ruleType  String   @map("rule_type") // sensitive_word, duplicate_detection, content_quality
  content   String   @db.Text
  action    String   // block, mark
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("risk_rules")
}

// ============================================
// 审计相关模型
// ============================================

/// 审计日志表
model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@index([action])
  @@map("audit_logs")
}

